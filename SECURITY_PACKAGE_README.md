# 服务器安全事件处理 - 完整文档包

## 📚 文档概览

本目录包含服务器 120.48.95.51 安全事件的完整处理文档和工具。

### 文档列表

| 文件名 | 类型 | 说明 |
|--------|------|------|
| **SECURITY_INCIDENT_REPORT.md** | 报告 | 详细的安全事件报告，包含威胁分析、入侵路径和清理步骤 |
| **EXECUTION_PLAN.md** | 指南 | 详细的安全清理执行计划，包含4个阶段的完整操作步骤 |
| **QUICK_REFERENCE.md** | 参考 | 快速参考指南，包含常用命令和检查清单 |
| **SECURITY_README.md** | 说明 | 安全事件处理文档包的使用指南 |
| **security_cleanup.sh** | 脚本 | 自动化安全清理脚本 |
| **server_security_monitor.sh** | 脚本 | 服务器安全监控脚本 |

---

## 🚨 事件摘要

**时间**: 2025年12月31日  
**服务器**: 120.48.95.51  
**威胁类型**: 
- XMRig加密货币挖矿程序
- 恶意反向代理
- SSH暴力破解攻击
- 持久化后门机制

**影响范围**:
- postgres用户账户被入侵
- 恶意进程占用系统资源
- 系统配置被篡改
- 数据库配置存在安全漏洞

---

## 📋 快速开始

### 方案一：自动化清理（推荐）

如果您能够SSH连接到服务器，可以执行自动化清理脚本：

```bash
# 1. 上传清理脚本到服务器
scp security_cleanup.sh root@120.48.95.51:/root/

# 2. SSH登录服务器
ssh root@120.48.95.51

# 3. 执行清理脚本
chmod +x /root/security_cleanup.sh
sudo /root/security_cleanup.sh
```

### 方案二：手动执行

如果无法使用自动化脚本，请按照 **EXECUTION_PLAN.md** 中的步骤手动执行：

1. **紧急清理**（5-10分钟）
   - 停止恶意进程
   - 删除恶意文件
   - 清理启动配置

2. **安全加固**（10-15分钟）
   - 修改用户密码
   - 处理SSH密钥
   - 配置防火墙
   - 安装fail2ban
   - 修复PostgreSQL配置
   - 加固SSH配置

3. **验证和监控**（5-10分钟）
   - 验证清理结果
   - 检查系统服务
   - 生成安全报告

4. **后续监控**（持续）
   - 设置每日监控
   - 配置告警通知

---

## 🔧 使用监控脚本

### 安装监控脚本

```bash
# 1. 上传监控脚本到服务器
scp server_security_monitor.sh root@120.48.95.51:/root/

# 2. SSH登录服务器
ssh root@120.48.95.51

# 3. 安装脚本
chmod +x /root/server_security_monitor.sh

# 4. 手动执行一次测试
/root/server_security_monitor.sh

# 5. 添加到crontab（每天8点执行）
(crontab -l 2>/dev/null; echo "0 8 * * * /root/server_security_monitor.sh >> /var/log/server_security_monitor.log 2>&1") | crontab -
```

### 监控脚本功能

监控脚本会自动检查以下内容：

1. ✅ 恶意进程（bioset, .netd, xmrig等）
2. ✅ 恶意文件（/var/tmp/.sys, /tmp/init等）
3. ✅ 配置文件（.profile, .bashrc等）
4. ✅ 网络连接（恶意IP、挖矿连接）
5. ✅ 系统负载
6. ✅ 内存使用
7. ✅ 磁盘使用
8. ✅ 服务状态（PostgreSQL, SSH, fail2ban）
9. ✅ 登录失败记录
10. ✅ 防火墙状态
11. ✅ fail2ban状态
12. ✅ SSH配置
13. ✅ PostgreSQL配置

### 查看监控日志

```bash
# 查看监控日志
tail -f /var/log/server_security_monitor.log

# 查看安全告警
tail -f /var/log/security_alerts.log
```

---

## ⚠️ 紧急提醒

### 立即执行（优先级：高）

1. **修改所有用户密码**
   - postgres用户密码
   - root用户密码
   - 其他用户密码

2. **检查SSH密钥**
   - 审查所有authorized_keys文件
   - 删除可疑的SSH密钥
   - 重新生成密钥对（可选）

3. **修复PostgreSQL配置**
   - 将trust认证改为md5或scram-sha-256
   - 限制数据库访问IP
   - 修改数据库用户密码

4. **启用防火墙**
   - 安装并启用ufw
   - 只开放必要的端口
   - 限制访问来源IP

5. **持续监控**
   - 部署监控脚本
   - 配置告警通知
   - 定期检查系统状态

### 24小时内完成

- [ ] 审查所有用户账户
- [ ] 检查系统日志
- [ ] 更新系统补丁
- [ ] 备份重要数据
- [ ] 制定安全策略

### 1周内完成

- [ ] 全面安全扫描
- [ ] 渗透测试
- [ ] 安全培训
- [ ] 建立监控体系
- [ ] 制定应急响应计划

---

## 📊 当前系统状态

### 已发现的问题

根据之前的检查，服务器存在以下问题：

1. **恶意进程**
   - .netd进程（PID: 2119225）
   - bioset进程
   - /tmp/init进程

2. **恶意文件**
   - /var/tmp/.sys/.netd
   - /var/tmp/.sys/.bioset
   - /tmp/init

3. **配置篡改**
   - /home/postgres/.profile被修改
   - 包含恶意启动命令

4. **数据库配置**
   - PostgreSQL使用trust认证
   - 存在权限问题

5. **安全漏洞**
   - SSH可能允许密码认证
   - 防火墙未启用
   - fail2ban未配置

### 已完成的工作

- ✅ 创建了完整的安全事件报告
- ✅ 创建了详细的执行计划
- ✅ 创建了快速参考指南
- ✅ 创建了自动化清理脚本
- ✅ 创建了安全监控脚本

---

## 🔍 验证清单

### 清理后验证

- [ ] 恶意进程已完全停止
- [ ] 恶意文件已完全删除
- [ ] 配置文件已清理
- [ ] 用户密码已修改
- [ ] SSH密钥已处理
- [ ] 防火墙已启用
- [ ] fail2ban已配置
- [ ] PostgreSQL已加固
- [ ] SSH已加固
- [ ] 监控已设置

### 功能验证

- [ ] SSH登录正常（使用密钥认证）
- [ ] PostgreSQL服务正常
- [ ] 应用程序正常
- [ ] 数据库连接正常
- [ ] 系统负载正常
- [ ] 网络连接正常

---

## 📞 应急联系

### 执行过程中遇到问题

1. **系统无法启动**: 联系系统管理员
2. **服务无法启动**: 查看服务日志 `journalctl -u service_name`
3. **无法SSH登录**: 使用控制台登录
4. **数据丢失**: 从备份恢复

### 回滚方案

如果清理后出现问题，可以：

1. 从备份目录恢复配置文件
2. 恢复系统快照（如果支持）
3. 联系技术支持

---

## 📝 执行记录

### 执行人: ___________
### 执行时间: ___________
### 完成状态: ___________

### 验证清单
- [ ] 恶意进程已停止
- [ ] 恶意文件已删除
- [ ] 配置文件已清理
- [ ] 密码已修改
- [ ] SSH密钥已处理
- [ ] 防火墙已启用
- [ ] fail2ban已配置
- [ ] PostgreSQL已加固
- [ ] SSH已加固
- [ ] 监控已设置

### 备注
_____________________________________________
_____________________________________________
_____________________________________________

---

## 📖 文档使用指南

### SECURITY_INCIDENT_REPORT.md
**用途**: 详细了解安全事件的完整情况  
**何时使用**: 
- 需要了解事件详情时
- 需要向管理层汇报时
- 需要编写安全报告时

**内容**:
- 恶意软件详情
- 入侵路径分析
- 清理步骤
- 长期安全加固措施

### EXECUTION_PLAN.md
**用途**: 执行安全清理操作的详细指南  
**何时使用**: 
- 开始清理操作前
- 执行清理操作时
- 遇到问题时

**内容**:
- 4个阶段的详细步骤
- 每个步骤的具体命令
- 验证和回滚方案
- 应急联系方式

### QUICK_REFERENCE.md
**用途**: 快速查找常用命令和检查清单  
**何时使用**: 
- 需要快速执行某个操作时
- 需要检查系统状态时
- 需要验证清理结果时

**内容**:
- 紧急命令
- 检查命令
- 安全加固命令
- 检查清单

### security_cleanup.sh
**用途**: 自动化执行安全清理操作  
**何时使用**: 
- 能够SSH连接到服务器时
- 希望自动化执行清理时

**功能**:
- 停止恶意进程
- 删除恶意文件
- 清理配置文件
- 修改密码
- 配置防火墙
- 安装fail2ban
- 生成安全报告

### server_security_monitor.sh
**用途**: 持续监控服务器安全状态  
**何时使用**: 
- 清理完成后
- 需要持续监控时

**功能**:
- 检查恶意进程
- 检查恶意文件
- 检查配置文件
- 检查网络连接
- 检查系统资源
- 检查服务状态
- 生成监控报告

---

## 🎯 下一步行动

### 立即行动（现在）

1. **选择执行方案**
   - 如果能够SSH连接：使用自动化脚本
   - 如果无法SSH连接：按照执行计划手动执行

2. **开始清理操作**
   - 阅读EXECUTION_PLAN.md
   - 按照步骤执行清理
   - 验证清理结果

3. **部署监控脚本**
   - 上传server_security_monitor.sh
   - 配置定时任务
   - 测试监控功能

### 短期行动（24小时内）

1. **系统加固**
   - 更新系统补丁
   - 审查用户账户
   - 配置访问控制

2. **数据备份**
   - 备份重要数据
   - 验证备份完整性
   - 制定备份策略

3. **安全审计**
   - 检查系统日志
   - 分析访问记录
   - 识别异常行为

### 长期行动（1周内）

1. **安全体系建设**
   - 制定安全策略
   - 建立监控体系
   - 制定应急响应计划

2. **人员培训**
   - 安全意识培训
   - 操作规范培训
   - 应急响应培训

3. **持续改进**
   - 定期安全扫描
   - 定期安全审计
   - 持续优化安全措施

---

## 📚 参考资源

### 安全工具

- **rkhunter**: Rootkit检测工具
- **chkrootkit**: Rootkit检测工具
- **lynis**: 安全审计工具
- **nmap**: 端口扫描工具
- **fail2ban**: 入侵防御工具

### 安全文档

- [CIS Ubuntu Linux Benchmark](https://www.cisecurity.org/cis-benchmarks/)
- [Ubuntu Security Guide](https://ubuntu.com/security)
- [PostgreSQL Security](https://www.postgresql.org/docs/current/security.html)
- [SSH Security Best Practices](https://www.ssh.com/academy/ssh/security)

### 应急响应

- [NIST Incident Response Guide](https://csrc.nist.gov/publications/detail/sp/800-61/rev-2/final)
- [SANS Incident Response](https://www.sans.org/white-papers/incident-response/)
- [OWASP Incident Response](https://owasp.org/www-community/Incident_Response)

---

## 📄 版本信息

**文档版本**: 1.0  
**创建日期**: 2025年12月31日  
**最后更新**: 2025年12月31日  
**维护者**: 系统安全团队

---

## 📧 联系方式

如有问题或建议，请联系：

- **系统管理员**: [填写联系方式]
- **安全团队**: [填写联系方式]
- **数据库管理员**: [填写联系方式]

---

**⚠️ 重要提醒**: 

1. 在执行任何清理操作前，请确保已备份重要数据
2. 严格按照执行计划的步骤操作
3. 遇到问题时，及时寻求帮助
4. 清理完成后，务必验证所有功能正常
5. 持续监控系统状态，及时发现异常

**🔒 安全第一**: 系统安全是持续的过程，需要定期检查和维护。请确保按照文档中的建议，建立完善的安全体系和监控机制。

---

*本文档包由AI助手生成，仅供参考。实际操作时请根据实际情况调整。*
