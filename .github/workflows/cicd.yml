name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm install
  
  
    - name: Run tests
      run: npm run test:local
      
  deploy:
    needs: build-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: 22
        script: |
          # 设置Node.js环境变量
          export PATH=/www/server/nodejs/v24.12.0/bin:$PATH
          
          # 进入项目目录
          cd /www/wwwroot/egg-example-picooc
          
          # 配置Git以处理网络问题
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          git config --global core.compression 0
          
          # 拉取最新代码（带重试机制）
          echo "开始拉取最新代码..."
          MAX_RETRIES=3
          RETRY_COUNT=0
          PULL_SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "尝试拉取代码 (第 $((RETRY_COUNT + 1))/$MAX_RETRIES 次)..."
            if git pull origin main; then
              echo "✓ 代码拉取成功"
              PULL_SUCCESS=true
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "✗ 代码拉取失败，等待5秒后重试..."
                sleep 5
              fi
            fi
          done
          
          if [ "$PULL_SUCCESS" = false ]; then
            echo "✗ 代码拉取失败，尝试使用fetch和reset..."
            git fetch origin main
            git reset --hard origin/main
            if [ $? -eq 0 ]; then
              echo "✓ 代码更新成功（使用fetch+reset）"
            else
              echo "✗ 代码更新失败，部署终止"
              exit 1
            fi
          fi
          
          # 安装依赖
          npm install --production
          
          # PostgreSQL数据库连接检查和修复
          echo "=== 开始PostgreSQL数据库连接检查 ==="
          
          # 检查PostgreSQL服务状态
          echo "检查PostgreSQL服务状态..."
          if systemctl is-active --quiet postgresql; then
            echo "✓ PostgreSQL服务运行正常"
          else
            echo "✗ PostgreSQL服务未运行,尝试启动..."
            systemctl start postgresql
            sleep 3
            if systemctl is-active --quiet postgresql; then
              echo "✓ PostgreSQL服务启动成功"
            else
              echo "✗ PostgreSQL服务启动失败,尝试重启..."
              systemctl restart postgresql
              sleep 3
            fi
          fi
          
          # 检查恶意进程
          echo "检查恶意进程..."
          MALICIOUS_PROCESSES=$(ps aux | grep -E 'wget.*80.64.16.241/pg\.sh|systemd-tmpfiles-cleanup-vNcsJu\.sh|r4jCvzA|zn4NUkj' | grep -v grep || true)
          if [ -n "$MALICIOUS_PROCESSES" ]; then
            echo "⚠ 发现恶意进程，正在终止..."
            pkill -f 'wget.*80.64.16.241/pg.sh' || true
            pkill -f 'systemd-tmpfiles-cleanup-vNcsJu.sh' || true
            pkill -f 'r4jCvzA' || true
            pkill -f 'zn4NUkj' || true
            sleep 2
            # 验证进程是否已终止
            REMAINING_PROCESSES=$(ps aux | grep -E 'wget.*80.64.16.241/pg\.sh|systemd-tmpfiles-cleanup-vNcsJu\.sh|r4jCvzA|zn4NUkj' | grep -v grep || true)
            if [ -z "$REMAINING_PROCESSES" ]; then
              echo "✓ 恶意进程已终止"
            else
              echo "⚠ 部分恶意进程仍在运行，继续部署..."
            fi
          else
            echo "✓ 未发现恶意进程"
          fi
          
          # 检查恶意定时任务
          echo "检查恶意定时任务..."
          MALICIOUS_CRON=$(crontab -u postgres -l 2>/dev/null | grep -E '80.64.16.241|systemd-tmpfiles-cleanup' || true)
          if [ -n "$MALICIOUS_CRON" ]; then
            echo "⚠ 发现恶意定时任务，正在删除..."
            crontab -u postgres -r
            echo "✓ 恶意定时任务已删除"
          else
            echo "✓ 未发现恶意定时任务"
          fi
          
          # 删除恶意脚本目录
          if [ -d "/home/postgres/.config/systemd/user/systemd-tmpfiles-cleanup" ]; then
            echo "删除恶意脚本目录..."
            rm -rf /home/postgres/.config/systemd/user/systemd-tmpfiles-cleanup
            echo "✓ 恶意脚本目录已删除"
          fi
          
          # 测试数据库连接
          echo "测试数据库连接..."
          DB_HOST=${PG_HOST:-'120.48.95.51'}
          DB_PORT=${PG_PORT:-5432}
          DB_NAME=${PG_DATABASE:-'egg_example'}
          DB_USER=${PG_USERNAME:-'egg_example'}
          
          # 使用psql测试连接
          if command -v psql &> /dev/null; then
            PGPASSWORD=${PG_PASSWORD:-'1994514Xia@'} psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -c "SELECT 1;" &> /dev/null
            if [ $? -eq 0 ]; then
              echo "✓ 数据库连接成功"
            else
              echo "✗ 数据库连接失败，尝试修复..."
              # 重启PostgreSQL服务
              systemctl restart postgresql
              sleep 5
              # 再次测试连接
              PGPASSWORD=${PG_PASSWORD:-'1994514Xia@'} psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -c "SELECT 1;" &> /dev/null
              if [ $? -eq 0 ]; then
                echo "✓ 数据库连接修复成功"
              else
                echo "✗ 数据库连接修复失败，请手动检查"
                exit 1
              fi
            fi
          else
            echo "⚠ 未安装psql 跳过连接测试"
          fi
          
          echo "=== PostgreSQL数据库检查完成 ==="
          
          # 执行数据库初始化脚本（创建缺失的表）
          echo "=== 执行数据库初始化脚本 ==="
          if [ -f "init-database.sql" ]; then
            echo "执行 init-database.sql..."
            PGPASSWORD=${PG_PASSWORD:-'1994514Xia@'} psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -f init-database.sql
            if [ $? -eq 0 ]; then
              echo "✓ 数据库初始化脚本执行成功"
            else
              echo "⚠ 数据库初始化脚本执行失败，继续部署..."
            fi
          else
            echo "⚠ 未找到 init-database.sql 文件"
          fi
          
    
          # 显示状态
          pm2 status
          
          # 重启应用以加载最新代码
          echo "重启PM2应用..."
          pm2 restart egg-example-picooc || pm2 restart all
          
          # 验证应用状态
          echo "验证应用状态..."
          sleep 5
          pm2 status
          
          # 健康检查
          echo "执行应用健康检查..."
          HEALTH_CHECK_RETRIES=5
          HEALTH_CHECK_COUNT=0
          HEALTH_CHECK_SUCCESS=false
          
          while [ $HEALTH_CHECK_COUNT -lt $HEALTH_CHECK_RETRIES ]; do
            echo "健康检查 (第 $((HEALTH_CHECK_COUNT + 1))/$HEALTH_CHECK_RETRIES 次)..."
            if curl -f -s http://localhost:7001/health > /dev/null 2>&1; then
              echo "✓ 应用健康检查通过"
              HEALTH_CHECK_SUCCESS=true
              break
            else
              HEALTH_CHECK_COUNT=$((HEALTH_CHECK_COUNT + 1))
              if [ $HEALTH_CHECK_COUNT -lt $HEALTH_CHECK_RETRIES ]; then
                echo "⚠ 应用未响应，等待3秒后重试..."
                sleep 3
              fi
            fi
          done
          
          if [ "$HEALTH_CHECK_SUCCESS" = false ]; then
            echo "✗ 应用健康检查失败，请检查应用日志"
            pm2 logs --lines 20 --nostream
            exit 1
          fi
          
          # 验证Node.js版本
          echo "Node.js版本:" && node -v
          echo "npm版本:" && npm -v
          
          # 显示PostgreSQL服务状态
          echo "PostgreSQL服务状态:"
          systemctl status postgresql --no-pager | head -10
          
          echo "=== 部署完成 ==="